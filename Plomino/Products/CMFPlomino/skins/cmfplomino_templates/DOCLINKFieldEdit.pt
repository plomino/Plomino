<span tal:define="widget python:options['field'].getSettings('widget');
				selection python:options['selection'];
				name python:options['fieldname'];
				current python:options['fieldvalue']
				">
	<tal:widget tal:condition="python:test(widget=='SELECT')">
		<select tal:attributes="name name"><tal:loop tal:repeat="v selection">
			<option tal:define="l python:v.split('|')"
				tal:attributes="value python:l[1]; selected python:test(current==l[1],1,0)"
				tal:content="python:l[0]">value</option>
		</tal:loop></select>
	</tal:widget>
	<tal:widget tal:condition="python:test(widget=='MULTISELECT')">
		<select tal:attributes="name name" multiple="true" lines="4"><tal:loop tal:repeat="v selection">
				<tal:block tal:define="l python:v.split('|')">
					<option 
						tal:attributes="value python:l[1]; selected python:test(current and l[1] in current,1,0)"
						tal:content="python:l[0]">value</option>
				</tal:block>
		</tal:loop></select>
	</tal:widget>
	<tal:widget tal:condition="python:test(widget=='VIEW')" >
		<table tal:define="sourceview python:options['field'].getSettings('sourceview');
	                       v python:options['field'].getParentDatabase().getView(sourceview);
	                       columns python:v.getColumns()">
			<tr>
				<th>&nbsp;&nbsp;</th>
				<tal:block tal:repeat="c columns">
					<th tal:condition="not: c/HiddenColumn|nothing">&nbsp;<span
						tal:content="c/Title">Title</span>&nbsp;</th>
				</tal:block>
			</tr>
			<tal:documents tal:define="listdocuments python:[d for d in v.getAllDocuments() if test(v.hasReadPermission(v.getParentDatabase().getDocument(d.getPath().split('/')[-1]))==True)];"
						tal:repeat="doc listdocuments">
				<tr tal:define="oddrow repeat/doc/odd"
					tal:attributes="class python:test(oddrow, 'even', 'odd')">
					<td><input type="checkbox" 
					tal:attributes="name options/fieldname;
							value python:doc.getPath();
							checked python:test(current and doc.getPath() in current,1,0)">
					</td>
					<tal:block tal:repeat="c columns">
						<td tal:condition="not: c/HiddenColumn|nothing"><span
							tal:define="cname c/id;
										vname v/id;
										cvalue python:getattr(doc, v.getIndexKey(cname));
										"
							tal:content="structure cvalue" /></td>
					</tal:block>
				</tr>
			</tal:documents>
		</table>
	</tal:widget>
	
	<tal:widget tal:condition="python:test(widget=='DYNAMICTABLE')"
		tal:define="fieldid options/field/id;
	    			data python:options['field'].getSettings().tojson(selection);
	    			cols python:options['field'].getSettings().getJQueryColumns();
	    			params python:options['field'].getSettings('dynamictableparam');
	    			selected python:'|'.join(current);
	    			">
        <script type='text/javascript' tal:content="structure string:
			var o_${fieldid}_DynamicTable;
			$(document).ready(function() {
			    o_${fieldid}_DynamicTable = $('#${fieldid}_table').dataTable( {
			        'aaData': ${data},
			        'aoColumns': ${cols},
			        'aaSorting': [],
			        'fnRowCallback': function (nRow, aData, iDisplayIndex) {
			            var iId = aData[0];
			            if ('${selected}'.indexOf(iId) != -1)
			                $(nRow).addClass('row_selected');
			            return nRow;
			        },
			        ${params}
			    });
			 
			    $('#${fieldid}_table tbody tr').live('click', function () {
			        var aData = o_${fieldid}_DynamicTable.fnGetData( this );
			        var iId = aData[0];
			        
			        var docInput = document.getElementById('${fieldid}');
			        
			        var selectedDocs = docInput.value;
			        selectedDocs = selectedDocs.indexOf(iId) == -1 ? selectedDocs + iId + '|' : selectedDocs.replace(iId + '|', '');
			        docInput.value = selectedDocs;
			        
			        $$(this).toggleClass('row_selected');
			    } );
			});
		"></script>
        <table id='dynamictable_table' tal:attributes="id string:${name}_table" class="display"></table>
        <div style="clear: both"></div>
        <input type="hidden" tal:attributes="name options/fieldname; id string:${name};
                                          value python:test(current is not None,'|'.join(current),'')"/>
    </tal:widget>
    
	<tal:widget tal:condition="python:test(widget=='PICKLIST')"
		tal:define="fieldid options/field/id;
	    			data python:options['field'].getSettings().tojson(selection);
	    			cols python:options['field'].getSettings().getJQueryColumns();
	    			params python:options['field'].getSettings('dynamictableparam');
	    			selected python:'|'.join(current);
	    			colindex python:options['field'].getSettings().getColumnLabelIndex();
	    			">
        <script type='text/javascript' tal:content="structure string:
		 	function ${name}_delete_row(elt) {
				var rows = $('#${name}_table_result > tbody > tr');
				if (rows.length <= 1)
					$('#${name}_table_result > tbody').append('<tr><td></td><td><input type=\'hidden\' name=\'${name}\' value=\'\' /></td></tr>');
				$(elt).closest('tr').remove();
		 	}

		 	function ${name}_add_row(data) {
		 		var tablebody = $('#${name}_table_result > tbody');
		 		if (tablebody.has('input[value=' + data[0] + ']').length == 0) {
		 			tablebody.children().has('input[value=]').remove()
			 		var row = $('<tr><td>' + data[${colindex} + 1] + '</td><td>' +
					 			'<img alt=\'Remove\' src=\'delete_icon.gif\' onclick=\'${name}_delete_row(this)\' />' +
						 		'<input type=\'hidden\' name=\'${name}\' value=\'' + data[0] + '\' /></td></tr>');
			 		tablebody.append(row);
		 		}
		 	}
			
			var o_${fieldid}_table;
			$$(document).ready(function() {
			    o_${fieldid}_table = $('#${fieldid}_table').dataTable( {
			        'aaData': ${data},
			        'aoColumns': ${cols},
			        'aaSorting': [],
			        'fnInitComplete': function(oSettings) {
				        for (var i = 0; i < oSettings.aoData.length; i++)
				            if ('${selected}'.indexOf(oSettings.aoData[i]._aData[0]) != -1)
					        	${name}_add_row(oSettings.aoData[i]._aData);
			        },
			        ${params}
			    });
			 
			    $('#${fieldid}_table tbody tr').live('click', function () {
			    	${name}_add_row(o_${name}_table.fnGetData(this));
			    } );
			});
		"></script>
			
		<table tal:attributes="id python:name + '_table_result'">
			<tbody></tbody>
		</table>
		
        <table id='dynamictable_table' tal:attributes="id string:${name}_table" class="display"></table>
        <div style="clear: both"></div>
    </tal:widget>
</span>
