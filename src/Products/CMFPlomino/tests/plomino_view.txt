Plomino view tests
==================

Set up login account

    >>> portal = layer['portal']
    >>> memberName = 'siteManager'
    >>> portal.portal_membership.addMember(
    ...         memberName,
    ...         memberName,
    ...         ('Member', 'Manager',),
    ...         '',
    ...         {'fullname': 'Site Manager', 'email': memberName+'@dummy.fr',}
    ...         )

Open portal:

    >>> db = portal.mydb
    >>> wf_tool = portal.portal_workflow
    >>> wf_tool.doActionFor(db, 'publish')
    >>> transaction.commit()

    >>> browser = Browser(layer['app'])
    >>> browser.handleErrors = False
    >>> portal_url = portal.absolute_url()
    >>> browser.open(portal_url)

Log in with ``Site Manager`` access rights::

    >>> browser.getLink('Log in').click()
    >>> browser.getControl('Login Name').value = 'siteManager'
    >>> browser.getControl('Password').value = 'siteManager'
    >>> browser.getControl('Log in').click()

When csv export in view, the multi select data is readable in csv file

    >>> id = db.invokeFactory("PlominoForm",
    ...         id="frm1",
    ...         title="Form 1")
    >>> id = db.frm1.invokeFactory("PlominoField",
    ...         id="field1",
    ...         title="Title for field 1",
    ...         field_type="TEXT",
    ...         field_mode="EDITABLE")
    >>> id = db.frm1.invokeFactory("PlominoField",
    ...         id="field2",
    ...         title="Title for field 2",
    ...         field_type="SELECTION",
    ...         field_mode="EDITABLE")
    >>> db.frm1.field2.widget = "CHECKBOX"
    >>> db.frm1.field2.selectionlist = [
    ...         u"John Paul Jones",
    ...         u"Chris Chameleon",
    ...         u"Serba, John"]
    >>> id = db.frm1.invokeFactory("PlominoField",
    ...         id="field3",
    ...         title="Title for field 3",
    ...         field_type="SELECTION",
    ...         field_mode="EDITABLE")
    >>> db.frm1.field3.widget = "CHECKBOX"
    >>> db.frm1.field3.selectionlist = [
    ...         u"Jones John Paul",
    ...         u"Chameleon Chris",
    ...         u"John, Serba"]
    >>> id = db.invokeFactory("PlominoView",
    ...         id="view1",
    ...         title="View 1",
    ...         selection_formula="plominoDocument.getItem('Form')=='frm1'")
    >>> id = db.view1.invokeFactory("PlominoColumn",
    ...         id="col1",
    ...         title="Col 1",
    ...         formula="plominoDocument.field1")
    >>> id = db.view1.invokeFactory("PlominoColumn",
    ...         id="col2",
    ...         title="Col 2",
    ...         displayed_field="frm1/field2")
    >>> id = db.view1.invokeFactory("PlominoColumn",
    ...         id="col3",
    ...         title="Col 3",
    ...         formula="plominoDocument.field3")
    >>> db.view1.sort_column = "col1"
    >>> doc1 = db.createDocument()
    >>> doc1.setItem("Form", "frm1")
    >>> doc1.setItem("field1", "sumo")
    >>> doc1.setItem("field2", [
    ...         u"John Paul Jones",
    ...         u"Chris Chameleon"])
    >>> doc1.setItem("field3", [
    ...         u"John, Serba"])
    >>> doc1.save(creation=True)
    >>> doc2 = db.createDocument()
    >>> doc2.setItem("Form", "frm1")
    >>> doc2.setItem("field1", "sumi")
    >>> doc2.setItem("field2", [
    ...         u"Serba, John"])
    >>> doc2.setItem("field3", [
    ...         u"Jones John Paul",
    ...         u"Chameleon Chris"])
    >>> doc2.save(creation=True)
    >>> len(db.view1.getAllDocuments())
    2
    >>> db.view1.exportCSV()
    '"sumi"\t"Serba\\, John"\t"Jones John Paul, Chameleon Chris"\r\n"sumo"\t"John Paul Jones, Chris Chameleon"\t"John\\, Serba"\r\n'


Render View
===========

    >>> transaction.commit()
    >>> browser.open(portal_url +'/mydb/view1')
    >>> '<th data-column="col1">Col 1</th>' in browser.contents
    True
    >>> '<th data-column="col2">Col 2</th>' in browser.contents
    True
    >>> '<th data-column="col3">Col 3</th>' in browser.contents
    True

The rest of the table is loaded via ajax. But we can view using static rendering flag

    >>> db.view1.static_rendering = True
    >>> transaction.commit()
    >>> browser.open(portal_url +'/mydb/view1')
    >>> 'sumi' in browser.contents
    True
    >>> '2 documents' in browser.contents
    True

#TODO [u'John, Serba'] shouldn't be in there


Open documents
==============

    >>> browser.getLink('sumi').click()

#    >>> 'Title for field 1' in browser.contents
#    True
#    >>> 'sumi' in browser.contents
#    True

    >>> browser.getControl(name="plomino_edit")
    <Control name='plomino_edit' type='button'>
    >>> browser.getControl(name="plomino_close")
    <Control name='plomino_close' type='button'>
    >>> print browser.url
    http://nohost/plone/mydb/view1/document/...

Close button should use browser back

    >>> print browser.getControl(name="plomino_close").mech_control.attrs['onclick']
    history.go(-1)

When we close we will go back to the search form again

    #TODO requires JS



===============================================================================
Test import and export doesn't change view content
===============================================================================
Define the import + export function
   >>> def import_export():
   ...     dir, _ = os.path.split(os.path.abspath(__file__))
   ...     dir = os.path.join(dir,'tmp_export')
   ...     output_dir = os.path.join(dir,'mydb')
   ...     db.exportDesign(targettype='folder', targetfolder=dir)
   ...     db.importDesignFromJSON(from_folder=output_dir, replace=False)


    >>> import json, os
    >>> from os.path import join
    >>> db.view1.static_rendering = True
    >>> transaction.commit()
    >>> browser.open(db.view1.absolute_url())
    
    >>> '<th data-column="col1">Col 1</th>' in browser.contents
    True
    >>> len(db.view1.getAllDocuments())
    2
    >>> browser.open(portal_url +'/mydb/view1')
    >>> 'sumi' in browser.contents
    True
    >>> '2 documents' in browser.contents
    True

    # Without replace mode
    >>> dir, _ = os.path.split(os.path.abspath(__file__))
    >>> dir = os.path.join(dir,'tmp_export')
    >>> output_dir = os.path.join(dir,'mydb')
    >>> db.exportDesign(targettype='folder', targetfolder=dir)
    >>> db.importDesignFromJSON(from_folder=output_dir, replace=False)

    >>> len(db.view1.getAllDocuments())
    2
    >>> browser.open(portal_url +'/mydb/view1')
    >>> 'sumi' in browser.contents
    True
    >>> '2 documents' in browser.contents
    True

    # With replace mode. Test disabled until this is fixed
    >>> #dir, _ = os.path.split(os.path.abspath(__file__))
    >>> #dir = os.path.join(dir,'tmp_export')
    >>> #output_dir = os.path.join(dir,'mydb')
    >>> #db.exportDesign(targettype='folder', targetfolder=dir)
    >>> #db.importDesignFromJSON(from_folder=output_dir, replace=True)

    >>> #len(db.view1.getAllDocuments())
    #2
    >>> #browser.open(portal_url +'/mydb/view1')
    >>> #'sumi' in browser.contents
    #True
    >>> #'2 documents' in browser.contents
    #True

Exporting then importing the same database after some content has changes doesn't break the views
    >>> doc1.setItem("field4", "Field 4 exists!")
    >>> doc2.setItem("field4", "Field 4 exists!")
    >>> _ = db.frm1.invokeFactory("PlominoField",
    ...                            id="field4",
    ...                            title="Title for field 4",
    ...                            field_type="TEXT",
    ...                            field_mode="EDITABLE")
    >>> _ = db.view1.invokeFactory("PlominoColumn",
    ...                             id="col4",
    ...                             title="Col 4",
    ...                             displayed_field="frm1/field4")
    >>> db.refreshDB()
    [...]

    >>> len(db.view1.getAllDocuments())
    2
    >>> browser.open(portal_url +'/mydb/view1')

    >>> import_export()

    >>> len(db.view1.getAllDocuments())
    2
    >>> browser.open(portal_url +'/mydb/view1')



=======================================
Test unindexing document after deleted
=======================================

Delete document from the view will also unindex the document

    >>> doc_list = db.view1.getAllDocuments()

    >>> doc1.id in [doc.id for doc in doc_list]
    True
    >>> db.deleteDocuments(ids=[doc1.id])
    >>> doc_list = db.view1.getAllDocuments()
    >>> doc1.id not in [doc.id for doc in doc_list]
    True

    >>> doc2.id in [doc.id for doc in doc_list]
    True
    >>> db.deleteDocuments(ids=[doc2.id], massive=False)
    >>> doc_list = db.view1.getAllDocuments()
    >>> doc2.id not in [doc.id for doc in doc_list]
    True

Delete document by create new document and get exception

    >>> doc_list = db.view1.getAllDocuments()
    >>> len(db.view1.getAllDocuments())
    0
    >>> db.frm1.onCreateDocument = "return 'Error'"
    >>> db.frm1.form_layout = """<p><label for="field1">field1</label><span class="plominoFieldClass">field1</span></p>"""
    >>> transaction.commit()

    >>> form_url = portal_url +'/mydb' +'/frm1'
    >>> browser.open(form_url)
    >>> browser.getControl('Save').click()
    >>> len(db.view1.getAllDocuments())
    0


Views with subforms
===================


    >>> id = db.invokeFactory("PlominoForm",
    ...         id="sub1",
    ...         title="Form 1")
    >>> id = db.sub1.invokeFactory("PlominoField",
    ...         id="subfield1",
    ...         title="Title for sub field 1",
    ...         field_type="TEXT")
    >>> db.frm1.form_layout = """<span class="plominoSubformClass">sub1</span>"""

    >>> id = db.view1.invokeFactory("PlominoColumn",
    ...         id="subcol",
    ...         title="Sub Col",
    ...         displayed_field="sub1/subfield1")


    >>> doc3 = db.createDocument()
    >>> doc3.setItem("Form", "frm1")
    >>> doc3.setItem("sub1", "mysub1")
    >>> doc3.save(creation=True)
    >>> transaction.commit()


#    >>> len(db.view1.getAllDocuments())
#    1

#    >>> db.view1.exportCSV()





