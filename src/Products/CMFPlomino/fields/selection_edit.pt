<span tal:define="field python:options['field'];
    fieldvalue python:options['fieldvalue'];
    current python: fieldvalue;
    currentaslist python:(hasattr(current, 'append') and current) or [current] if current else [];
    widget python:field.widget;
    selection python:options['selection'];
    lselection python:[f.split('|') for f in selection];
    lvalue python:[e[1] for e in lselection];
    other_value python:[l for l in currentaslist if lvalue and l not in lvalue];
    tags python: None if not lselection else 'tags:'+  ','.join([v[1] for v in lselection])+'' ;
    initialValues python: None if not lselection or not currentaslist else 'initialValues:'+','.join([v[1]+':'+v[0] for v in lselection if v[1] in currentaslist]);
  "
    tal:attributes="class python:field.id + '-' + 'selectionfield' + (' combo-selectionfield' if field.allow_other_value else '') ">
    <tal:widget tal:condition="python:widget=='SELECT'">
        <tal:block tal:condition="python: not field.allow_other_value">
            <select class="pat-select2" tal:attributes="id field/id; name field/id">
                <tal:loop tal:repeat="v lselection">
                    <option
                        tal:attributes="value python:v[1]; selected python:(current==v[1] and 1) or (other_value and v[1]=='@@OTHER_VALUE')"
                        tal:content="python:v[0]">value</option>
                </tal:loop>
            </select>
         </tal:block>
        <tal:block tal:condition="python:field.allow_other_value">
            <input type="text" class="pat-select2" tal:attributes="id field/id;name field/id;  data-pat-select2 python:';;'.join(v for v in ['maximumSelectionSize:1',tags, initialValues] if v); value python:','.join(currentaslist)"/>
        </tal:block>
    </tal:widget>
    <tal:widget tal:condition="python:widget=='MULTISELECT'">
         <tal:block tal:condition="python: not field.allow_other_value">
            <select class="pat-select2" tal:attributes="id field/id; name field/id" multiple="true"  lines="4" >
                <tal:loop tal:repeat="v lselection">
                    <tal:block>
                        <option
                            tal:attributes="value python:v[1]; selected python:((currentaslist and v[1] in currentaslist) and 1) or 0"
                            tal:content="python:v[0]">value</option>
                    </tal:block>
                </tal:loop>
            </select>
         </tal:block>
        <tal:block tal:condition="python:field.allow_other_value">
            <input type="text" class="pat-select2" tal:attributes="id field/id;name field/id;  data-pat-select2 python:';;'.join(v for v in [tags, initialValues] if v); value python:','.join(currentaslist"/>
        </tal:block>
    </tal:widget>
    <tal:widget tal:condition="python:widget=='CHECKBOX'">
        <tal:block tal:repeat="v lselection">
            <tal:block>
                <span>
                    <tal:block tal:condition="python:v[1]!='@@OTHER_VALUE'">
                        <input type="checkbox"
                            tal:attributes="name field/id;
                                    value python:v[1];
                                    checked python:((currentaslist and v[1] in currentaslist) and 1) or 0;
                                    id python:field.id + '-' + v[1]">
                        <label tal:attributes="for python:field.id + '-' + v[1]" tal:content="structure python:v[0]">value</label>
                    </tal:block>
                    <tal:block tal:condition="python:v[1]=='@@OTHER_VALUE'">
                        <input type="checkbox"
                        tal:attributes="name python:field.id ;
                                value python:v[1];
                                checked python:len(other_value);
                                id python:field.id +  '_other'">
                        <label tal:attributes="for python:field.id + '_other'" tal:content="structure python:v[0]">value</label>
                    </tal:block>
                </span>
                <tal:sep tal:condition="not:repeat/v/end" tal:content="structure python:field.separator">separator</tal:sep>
            </tal:block>
        </tal:block>
        <tal:block tal:condition="python:field.allow_other_value">
            <input type="text" tal:attributes="id python:field.id +'@@OTHER_VALUE'; name python:field.id+'@@OTHER_VALUE'; value python:other_value[0] if len(other_value) else ''" placeholder="Enter new value"/>
        </tal:block>
    </tal:widget>
    <tal:widget tal:condition="python:widget=='RADIO'">
        <tal:block
            tal:repeat="v lselection">
            <tal:block>
                <span>
                    <tal:block tal:condition="python:v[1]!='@@OTHER_VALUE'">
                        <input type="radio"
                            tal:attributes="name field/id;
                                value python:v[1];
                                checked python:((currentaslist and v[1] in currentaslist) and 1) or 0;
                                id python:field.id + '-' + v[1]">
                        <label tal:attributes="for python:field.id + '-' + v[1]" tal:content="structure python:v[0]">value</label>
                    </tal:block>
                    <tal:block tal:condition="python:v[1]=='@@OTHER_VALUE'">
                        <input type="radio"
                            tal:attributes="name python:field.id ;
                                value python:v[1];
                                checked python:len(other_value);
                                id python:field.id + '_other'">
                        <label tal:attributes="for python:field.id + '_other'" tal:content="structure python:v[0]">value</label>
                    </tal:block>
                </span>
                <tal:sep tal:condition="not:repeat/v/end" tal:content="structure python:field.separator">separator</tal:sep>
            </tal:block>
        </tal:block>
        <tal:block tal:condition="python:field.allow_other_value">
            <input type="text" tal:attributes="id python:field.id +'@@OTHER_VALUE'; name python:field.id+'@@OTHER_VALUE'; value python:other_value[0] if len(other_value) else ''" placeholder="Enter new value"/>
        </tal:block>
    </tal:widget>

</span>
