<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
    xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    lang="en"
    metal:use-macro="context/main_template/macros/master"
    i18n:domain="Products.CMFPlomino">
<body>

<metal:javascript_head fill-slot="javascript_head_slot">
    <tal:block_hasjsresources
        tal:define="jsresources python:view.form.get_resources_js()"
        tal:condition="jsresources"
        tal:repeat="js jsresources">
        <script
            type="text/javascript"
            charset="iso-8859-1"
            tal:attributes="src js">
        </script>
    </tal:block_hasjsresources>
</metal:javascript_head>

<metal:css fill-slot="style_slot">
    <tal:block_hascssresources
        tal:define="cssresources python:view.form.get_resources_css()"
        tal:condition="cssresources"
        tal:repeat="css cssresources">
        <link rel="stylesheet"
            type="text/css"
            media="all"
            tal:attributes="href css" />
    </tal:block_hascssresources>
</metal:css>


<metal:content fill-slot="main">
    <h1 class="documentFirstHeading" tal:content="view/form/Title">Title</h1>
    <div id="content-core"
        tal:define="
            ispage view/form/isPage;
            searchform view/form/isSearchForm;
            form_method python:view.form.getFormMethod();
            macro_context python:request.get('Plomino_Macro_Context', None);">
        <form tal:condition="python:not(searchform or ispage)"
            id="plomino_form"
            tal:define="hasCreatePermissionOnDatabase python:view.form.hasCreatePermission(view.form.getParentDatabase());
                hasCreatePermissionOnForm python:view.form.hasCreatePermission(context);
                enctype python:(form_method == 'POST') and 'multipart/form-data'"
            tal:attributes="
                name view/form/id;
                action python:view.form.getFormAction(request);
                method python:view.form.getFormMethod();
                data-pat-plominodynamic string:url:${view/form/absolute_url};
                class python: macro_context and 'plomino-macro' or '';
                enctype enctype|nothing">
            <span tal:replace="structure view/form/@@authenticator/authenticator"/>
            <input type="hidden" name="Plomino_Macro_Context" tal:attributes="value python:'/'.join(here.getPhysicalPath());" tal:condition="macro_context" />

            <tal:block_no_createpermission
                condition="python:not(hasCreatePermissionOnDatabase and hasCreatePermissionOnForm)">
                <p i18n:domain="Products.CMFPlomino" i18n:translate="Please log in">Please log in</p>
            </tal:block_no_createpermission>

            <tal:block_has_createpermission
                condition="python:hasCreatePermissionOnDatabase and hasCreatePermissionOnForm">

                <div tal:condition="view/page_errors|nothing" id="validation_errors">
                    <div id="validation_failed">
                        <h1>Validation failed</h1>
                        <ul id="error_list">
                            <tal:errors repeat="e view/page_errors">
                                <li tal:content="structure e/error"
                                    tal:attributes="id string:error_${e/field}" />
                            </tal:errors>
                        </ul>
                    </div>
                </div>

                <tal:layout
                    tal:content="structure python:view.form.openBlankForm(request)">layout</tal:layout>
                <input tal:condition="view/request/Plomino_Parent_Field | nothing"
                    type="hidden"
                    name="Plomino_Parent_Field"
                    tal:attributes="value view/request/Plomino_Parent_Field;" />
                <input tal:condition="view/request/Plomino_Parent_Form | nothing"
                    type="hidden"
                    name="Plomino_Parent_Form | nothing"
                    tal:attributes="value view/request/Plomino_Parent_Form;" />

                <span metal:use-macro="view/form/plomino_actions/macros/OpenFormActionBar">display form actions</span><br/>
            </tal:block_has_createpermission>
        </form>

        <form tal:condition="ispage"
            enctype="multipart/form-data"
            id="plomino_form"
            tal:define="hasCreatePermissionOnDatabase python:view.form.hasCreatePermission(view.form.getParentDatabase());
                hasCreatePermissionOnForm python:view.form.hasCreatePermission(context);
                enctype python:(form_method == 'POST') and 'multipart/form-data'"
            tal:attributes="
                name view/form/id;
                action python:view.form.getFormAction(request);
                method python:view.form.getFormMethod();
                data-pat-plominodynamic string:url:${view/form/absolute_url};
                enctype enctype|nothing;
                class python: macro_context and 'plomino-macro' or '';">
            <span tal:replace="structure view/form/@@authenticator/authenticator"/>

            <input type="hidden" name="Plomino_Macro_Context" tal:attributes="value python:'/'.join(here.getPhysicalPath());" tal:condition="macro_context" />

            <div tal:condition="view/page_errors|nothing" id="validation_errors">
                <div id="validation_failed">
                    <h1>Validation failed</h1>
                    <ul id="error_list">
                        <tal:errors repeat="e view/page_errors">
                            <li tal:content="structure e/error"
                                tal:attributes="id string:error_${e/field}" />
                        </tal:errors>
                    </ul>
                </div>
            </div>

            <tal:layout
                tal:content="structure python:view.form.openBlankForm(request)">layout</tal:layout>
             <input tal:condition="view/request/Plomino_Parent_Field | nothing"
                    type="hidden"
                    name="Plomino_Parent_Field"
                    tal:attributes="value view/request/Plomino_Parent_Field;" />
                <input tal:condition="view/request/Plomino_Parent_Form | nothing"
                    type="hidden"
                    name="Plomino_Parent_Form | nothing"
                    tal:attributes="value view/request/Plomino_Parent_Form;" />

            <span metal:use-macro="view/form/plomino_actions/macros/OpenFormActionBar">display form actions</span><br/>
        </form>

        <form tal:condition="searchform"
            enctype="multipart/form-data"
            id="plomino_form"
            tal:define="hasReadPermissionOnDatabase python:view.form.hasReadPermission(view.form.getParentDatabase());
                hasReadPermissionOnForm python:view.form.hasReadPermission(context);
                enctype python:(form_method == 'POST') and 'multipart/form-data'"
             tal:attributes="
                name view/form/id;
                action string:${view/form/absolute_url}/OpenForm;
                method python:view.form.getFormMethod();
                enctype enctype|nothing
                ">
                    <div tal:replace="structure provider:plone.abovecontenttitle" />
                    <tal:block_has_readpermission
                        condition="python:(hasReadPermissionOnDatabase and hasReadPermissionOnForm)">
                        <tal:block_actionbar_top
                            define="owner python:view.form">
                            <span metal:use-macro="view/form/plomino_actions/macros/SearchFormActionBar">display form actions</span><br/>
                        </tal:block_actionbar_top>
                    </tal:block_has_readpermission>

                    <h1 class="documentFirstHeading" tal:content="here/Title">Title</h1>
                    <div tal:replace="structure provider:plone.belowcontenttitle" />

                    <div tal:replace="structure provider:plone.abovecontentbody" />

                    <tal:block_no_readpermission
                        condition="python:not(hasReadPermissionOnDatabase and hasReadPermissionOnForm)">
                        <p i18n:domain="CMFPlomino" i18n:translate="Please log in">Please log in</p>
                    </tal:block_no_readpermission>

                    <tal:block_has_readpermission
                        condition="python:(hasReadPermissionOnDatabase and hasReadPermissionOnForm)">

                        <span tal:content="structure python:here.formLayout(request)" />
                        <tal:results
                            define="searchviewname python:here.search_view;
                                    searchviewobj python:here.getParentDatabase().getView(searchviewname);
                                    searchviewfound python: searchviewobj is not None;
                                    ">
                            <tal:block_no_view_found
                                condition="not:searchviewfound">
                                <span tal:define="error python:here.writeMessageOnPage(searchviewname+' view does not exist.', here.REQUEST, error=True);" />
                            </tal:block_no_view_found>

                            <tal:block_view_found condition="searchviewfound">
                                <table
                                    tal:define="results python:view.form.searchDocuments(request);
                                                count python:len(results) if results else 0;
                                                paramstart request/start|python:'1';
                                                paramlimit request/limit|python:'100';
                                                start python:int(paramstart);
                                                limit python:int(paramlimit);
                                                overlimit python:count>limit;
                                                nextstart python:start+limit;
                                                previousstart python:max(1,start-limit);
                                                query_string python:request['QUERY_STRING'].replace('start=', '').replace('limit=', '');
                                                columns python:searchviewobj.getColumns()"
                                    id="sortable"
                                    class="listing"
                                    summary="Content listing"
                                    i18n:attributes="summary summary_content_listing;">
                                    <tr>
                                        <th tal:condition="python:not searchviewobj.hide_checkboxes">&nbsp;&nbsp;</th>
                                        <tal:block_column_titles repeat="c columns">
                                            <th tal:condition="not: c/HiddenColumn|nothing">&nbsp;<span
                                                tal:content="c/Title">Title</span>&nbsp;</th>
                                        </tal:block_column_titles>
                                    </tr>
                                    <tal:block_result_rows
                                        condition="results"
                                        repeat="doc python:results[start-1:start-1+limit]">

                                        <tr tal:define="
                                                oddrow repeat/doc/odd;
                                                docurl python:'../'+searchviewname+'/document/'+doc.getPath().split('/')[-1]"
                                            tal:attributes="class python:'odd' if oddrow else 'even';">
                                            <td tal:condition="python:not searchviewobj.hide_checkboxes">
                                                <input
                                                    type="checkbox"
                                                    name="sdoc"
                                                    tal:attributes="value python:doc.getPath().split('/')[-1]" />
                                            </td>
                                            <tal:block_column_values repeat="c columns">
                                                <td tal:condition="not: c/HiddenColumn|nothing"><a tal:attributes="href string:${docurl}"><span
                                                    tal:define="
                                                            cname c/id;
                                                            vname searchviewobj/id;
                                                            cvalue python:getattr(doc, searchviewobj.getIndexKey(cname), '');
                                                            "
                                                    tal:content="structure cvalue" ></span></a></td>
                                            </tal:block_column_values>
                                        </tr>
                                    </tal:block_result_rows>

                                    <!-- DOC COUNTING -->
                                    <tal:block_result_pagination condition="results">
                                        <tr tal:define="total_col python:len(columns) if searchviewobj.hide_checkboxes else len(columns)+1;">
                                            <th tal:attributes="colspan total_col"><tal:previous
                                                condition="python:start>1">
                                                <a i18n:translate=""
                                                    tal:attributes="href python:'/'.join(context.getPhysicalPath())+'/OpenForm?'+query_string+'&start='+str(previousstart)+'&limit='+str(limit)">&lt;&lt; Previous</a>
                                            </tal:previous>
                                            <tal:count i18n:translate="documents_count">
                                                 Document(s) <span i18n:name="start" tal:content="python:str(start)">start</span> to
                                                 <span i18n:name="end" tal:content="python:str(min(start+limit-1,count))">end</span>
                                                 of <span i18n:name="total" tal:content="count">count</span>
                                            </tal:count>
                                            <tal:next condition="python:count>start+limit-1">
                                                <a i18n:translate=""
                                                    tal:attributes="href python:request.physicalPathToURL(context.getPhysicalPath())+'/OpenForm?'+query_string+'&start='+str(nextstart)+'&limit='+str(limit)">Next &gt;&gt;</a>
                                            </tal:next></th>
                                        </tr>
                                    </tal:block_result_pagination>

                                </table>
                            </tal:block_view_found>
                        </tal:results>
                    </tal:block_has_readpermission>

                    <div tal:replace="structure provider:plone.belowcontentbody" />
                </form>

    </div>
</metal:content>
</body>
</html>
